#/usr/bin/env bash

# default value for the run name
run_name="latest"
port="8080"
debug=false
chlamdb_folder=""
metagenlab_folder=""

for i in "$@"; do
	case $i in
		--port=*)
			port="${i#*=}"
			shift
			;;
		--run_name=*)
			run_name="${i#*=}"
			shift
			;;
		-d|--debug)
			debug=true
			shift
			;;
		--chlamdb_folder=*)
			chlamdb_folder="${i#*=}"
			echo "$chlamdb_folder"
			shift
			;;
		--metagenlab_folder=*)
			metagenlab_folder="${i#*=}"
			shift
			;;
		-h|--help)
			echo ""
			echo "This script starts the web applcation, using by default the database "
			echo "that was generated by the latest run of the annotation pipeline"
			echo ""
			echo "Arguments:"
			echo "--run_name=NAME: tells the web application to use a different database than the latest"
			echo "--port=PORT: the web server will listen on a different port (default: 8080)"
			echo ""
			exit 0
	esac
done


if [ ! -f "singularity/zdb-1.0.sif" ]; then
	echo "Preparing the chlamdb container, this may take a while."
	singularity build singularity/zdb-1.0.sif docker://registry.hub.docker.com/metagenlab/zdb:1.0
	echo "Done"
fi


nextflow_dir=`pwd`
chlamdb_home="/home/chlamdb/"
chlamdb_home_debug=""
debugging_mode=""
bind_path="tmp/:/home/chlamdb/assets/temp/"
if [ "$debug" = true ]; then
	debugging_mode="-d"
	if [ ! -z "${metagenlab_folder}" ]; then
		export PYTHONPATH="$metagenlab_folder"
	fi

	if [ ! -z "${chlamdb_folder}" ]; then
		chlamdb_home="${chlamdb_folder}"
		bind_path="${chlamdb_folder}"
	fi
fi


echo "Starting website, it will be accessible through on localhost on port $port"
singularity run --writable-tmpfs --bind ${bind_path} \
	singularity/zdb-1.0.sif ${chlamdb_home}/start_webapp --nextflow_dir="${nextflow_dir}" \
	--run_name=${run_name} --port=${port} ${debugging_mode}
