#!/usr/bin/env bash

VERSION="1.0.0"
NEXTFLOW_DIR="/home/bmarquis/sda1/bmarquis/test_deployment/annotation_pipeline_nextflow/"
ZDB_DIR=""

if [[ $# == "0" || $1 == "help" ]]; then
	echo "zDB (v${VERSION})"
	echo "Available commands:"
	echo ""
	echo "setup - download and prepare the reference databases"
	echo ""
	echo "webapp - start the webapp"
	echo ""
	echo "run - run the analysis pipeline"
	echo ""
	echo "export - exports the results of a previous run in an archive"
	echo ""
	echo "import - unpack an archive that was prepared with the export command in the current directory"
	echo "       - so that the results can be used to start the webapp"
	echo ""
	echo "help - print this message"
	exit 0
fi


if [[ "$1" == "setup" ]]; then
	shift
	dir="$(pwd)/zdb_ref"
	db_setup_args=""

	for i in "$@"; do
		case $i in 
			--cog)
				db_setup_args="${db_setup_args} --cog"
				shift
				;;
			--ko)
				db_setup_args="${db_setup_args} --ko"
				shift
				;;
			--swissprot)
				db_setup_args="${db_setup_args} --swissprot"
				shift
				;;
			--pfam)
				db_setup_args="${db_setup_args} --pfam"
				shift
				;;
			--dir=*)
				dir=${i#*=}
				shift
				;;
			--help)
				echo "Downloads and sets up the reference database used by the analysis pipeline"
				echo ""
				echo "The following options can be used"
				echo ""
				echo " --cog: downloads the CDD profiles used for COG annotations "
				echo ""
				echo " --ko: downloads and setups the hmm profiles of the ko database"
				echo ""
				echo " --pfam: downloads and setups up the "
				echo ""
				echo " --swissprot: downloads and indexes the swissprot database "
				echo ""
				echo " --dir: directory where to store the reference databases (defaults zdb_ref in the current directory) "
				exit
				;;
			*)
				echo "Unknown option $i"
				exit 1
		esac
	done

	db_setup_args="${db_setup_args} --dir=${dir}"
	echo $db_setup_args
	exit 1
	echo "Preparing the reference databases, this will take some time"
	nextflow run $NEXTFLOW_DIR/db_setup.nf ${db_setup_args}
	echo "Done. The reference databases were prepared in the ${dir} folder"
	exit 0

elif [[ "$1" == "webapp" ]]; then
	shift
	$NEXTFLOW_DIR/bin/launch_webapp.sh "$@"
elif [[ "$1" == "run" ]]; then

	args=""

	for i in "$@"; do
		case $i in 
			--cog)
				args="${args} --cog"
				shift
				;;
			--ko)
				args="${args} --ko"
				shift
				;;
			--swissprot)
				args="${args} --swissprot"
				shift
				;;
			--pfam)
				args="${args} --pfam"
				shift
				;;
			--ref_dir=*)
				dir=${i#=*}
				shift
				;;
			--run_name=*)
				shift
				;;
			--help)
				echo "Downloads and sets up the reference database used by the analysis pipeline"
				echo ""
				echo "The following options can be used"
				echo " --cog: downloads the CDD profiles used for COG annotations "
				echo " --ko: downloads and setups the hmm profiles of the ko database"
				echo " --pfam: downloads and setups up the "
				echo " --swissprot: downloads and indexes the swissprot database "
				echo " --dir: directory where to store the reference databases (defaults zdb_ref in the current directory) "
				exit
				;;
			*)
				echo "Unknown option $i"
				exit 1
		esac
	done

	db_setup_args="${db_setup_args} --dir=${dir}"
	echo "Preparing the reference databases, this will take some time"
	nextflow run $NEXTFLOW_DIR/db_setup.nf ${db_setup_args}
	echo "Done. The reference databases were prepared in the ${dir} folder"
	exit 0

elif [[ "$1" == "export" ]]; then
	shift
	dir="$(pwd)/zdb/"
	run_name="latest"

	for i in "$@"; do
		case $i in 
			--dir=*)
				dir=${i#*=}
				shift
				;;
			--name=*)
				run_name=${i#*=}
				shift
				;;
			--help)
				echo "Exports the results of a given run name into an archive to make sharing easier"
				echo ""
				echo "The following options can be used"
				echo ""
				echo " --dir: specify the directory where the analysis was run"
				echo ""
				echo " --name: specify the run to be exported"
				exit
				;;
			*)
				echo "Unknown option $i"
				exit 1
		esac
	done
	 
	if [[ ! -d "$dir/zdb/results/" ]]; then
		echo "Could not access the results directory: $dir"
		exit 1
	elif [[ -f "$dir/results/.completed_runs/$name" ]]; then
		echo "Could not find run with name $name"
	fi
	unaliased_name=$(cat $dir/zdb/results/.completed_runs/$run_name)
	prefix="$dir/zdb/results/"

	tar zcvfh $run_name.tar.gz $prefix/alignments/$unaliased_name \
		$prefix/blast_DB/$unaliased_name $prefix/db/$unaliased_name \
		$prefix/gene_phylogenies/$unaliased_name $prefix/search_index/$unaliased_name
	echo "Created archive $run_name.tar.gz"
	exit 0

elif [[ "$1" == "import" ]]; then
	echo "Bar"
else
	echo "Unkown subcommand $1"
fi
